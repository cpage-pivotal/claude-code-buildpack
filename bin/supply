#!/usr/bin/env bash
# bin/supply: Supply script for Claude Code buildpack
# Installs Node.js and Claude Code CLI into the container

set -e
set -o pipefail

# Arguments
BUILD_DIR=$1
CACHE_DIR=$2
DEPS_DIR=$3
INDEX=$4

# Buildpack directory
BP_DIR=$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)

# Dependency installation directory
DEPS_INDEX_DIR="${DEPS_DIR}/${INDEX}"

# Source helper libraries
source "${BP_DIR}/lib/environment.sh"
source "${BP_DIR}/lib/installer.sh"
source "${BP_DIR}/lib/validator.sh"
source "${BP_DIR}/lib/mcp_configurator.sh"

# Create necessary directories
mkdir -p "${DEPS_INDEX_DIR}/bin"
mkdir -p "${DEPS_INDEX_DIR}/lib"
mkdir -p "${CACHE_DIR}"
# Note: .profile.d is created in BUILD_DIR by setup_environment()

echo "-----> Claude Code CLI Buildpack"

# Validate environment
echo "       Validating environment..."
validate_environment "${BUILD_DIR}"

# Install Node.js
echo "       Installing Node.js..."
install_nodejs "${DEPS_INDEX_DIR}" "${CACHE_DIR}"

# Install Claude Code CLI
echo "       Installing Claude Code CLI..."
install_claude_code "${DEPS_INDEX_DIR}" "${CACHE_DIR}"

# Set up environment variables
echo "       Configuring environment..."
setup_environment "${DEPS_INDEX_DIR}" "${BUILD_DIR}" "${INDEX}"

# Create configuration files
echo "       Creating configuration files..."
create_config_files "${DEPS_INDEX_DIR}" "${BUILD_DIR}"

# Extract .claude-code-config.yml from JAR if it's a Spring Boot application
if [ ! -f "${BUILD_DIR}/.claude-code-config.yml" ]; then
    echo "       Checking for config in JAR files..."
    echo "       BUILD_DIR contents: $(ls -la ${BUILD_DIR} 2>&1 | head -20)"
    # Find JAR files in the build directory
    jar_count=0
    for jar_file in "${BUILD_DIR}"/*.jar; do
        if [ -f "${jar_file}" ]; then
            jar_count=$((jar_count + 1))
            echo "       Found JAR #${jar_count}: $(basename ${jar_file})"
            # List contents of JAR to see if config file exists
            echo "       Checking JAR contents for .claude-code-config.yml..."
            unzip -l "${jar_file}" 2>/dev/null | grep -i "claude-code-config" || echo "       No claude-code-config.yml found in JAR"
            # Try to extract .claude-code-config.yml from the JAR root
            if unzip -p "${jar_file}" .claude-code-config.yml > "${BUILD_DIR}/.claude-code-config.yml" 2>/dev/null; then
                echo "       Extracted .claude-code-config.yml from JAR root"
                break
            fi
            # Try to extract from Spring Boot JAR structure (BOOT-INF/classes/)
            if unzip -p "${jar_file}" BOOT-INF/classes/.claude-code-config.yml > "${BUILD_DIR}/.claude-code-config.yml" 2>/dev/null; then
                echo "       Extracted .claude-code-config.yml from BOOT-INF/classes/"
                break
            fi
        else
            echo "       Pattern ${jar_file} is not a file (no JARs found)"
        fi
    done
    if [ ${jar_count} -eq 0 ]; then
        echo "       No JAR files found in BUILD_DIR"
    fi
fi

# Configure Claude Code (MCP servers and settings)
configure_claude_code "${BUILD_DIR}"

# Verify installation
echo "       Verifying installation..."
verify_installation "${DEPS_INDEX_DIR}"

echo "       Claude Code CLI installed successfully!"
echo "       Version: $(get_claude_version "${DEPS_INDEX_DIR}")"
