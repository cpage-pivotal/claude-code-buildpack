#!/usr/bin/env bash
# bin/detect: Detection script for Claude Code buildpack
# Exit 0 if this buildpack should be applied, exit 1 otherwise

set -e

BUILD_DIR=$1

# Buildpack metadata
BUILDPACK_NAME="Claude Code CLI"
BUILDPACK_VERSION="1.0.0"

# Detection logic
# Check for .claude-code-config.yml in the application root
if [ -f "${BUILD_DIR}/.claude-code-config.yml" ]; then
    echo "${BUILDPACK_NAME} ${BUILDPACK_VERSION}"
    exit 0
fi

# Check for CLAUDE_CODE_ENABLED environment variable
if [ "${CLAUDE_CODE_ENABLED}" == "true" ]; then
    echo "${BUILDPACK_NAME} ${BUILDPACK_VERSION}"
    exit 0
fi

# Check for manifest.yml with claude-code-enabled setting
# Note: This is simplified - in a real implementation, you'd parse YAML properly
if [ -f "${BUILD_DIR}/manifest.yml" ]; then
    if grep -q "claude-code-enabled.*true" "${BUILD_DIR}/manifest.yml" 2>/dev/null; then
        echo "${BUILDPACK_NAME} ${BUILDPACK_VERSION}"
        exit 0
    fi
fi

# Buildpack not applicable
exit 1
